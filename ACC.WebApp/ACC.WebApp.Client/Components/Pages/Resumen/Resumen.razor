@page "/Resumen"
@rendermode InteractiveServer
@implements IDisposable
@using ACC.Shared.DTOs
@using ACC.Shared.Core
@using ACC.WebApp.Client.Components.Pages.Guia.Components
@using ACC.WebApp.Client.Services
@using System.Security.Claims
@using System.Text.Json
@using System.Text.Json.Serialization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient cliente
@inject NavigationManager navegador
@inject ExamenesServiceClient ExamenesService
@inject ProgresoUsuarioClient ProgresoService

<div class="content resumen">
    @if (!string.IsNullOrEmpty(errorMessageUsuario))
    {
        <InfoComponent Title="@ErrorTitle" Message="@ErrorMessage" StatusCode="@ErrorStatusCode"
            ReturnUrl="@ErrorReturnUrl" />
    }
    else
    {
        <ResumenHeader 
            Usuario="usuario" 
            Tip="@tip" 
            MostrarTipEstado="mostrarTip" 
            HaVistoTip="haVistoTip"
            MostrarTip="MostrarTip" 
            ContinuarDondeLoDejaste="ContinuarDondeLoDejaste" IsLoadingUsuario="isLoadingUsuario"
            IsLoadingTip="isLoadingTip" 
            TipError="@errorMessageTip"
            CanContinue="@(!isLoadingUsuario && !string.IsNullOrEmpty(userId))" />

        @if (isLoadingUsuario)
        {
            <p>Cargando información del usuario...</p>
        }
        else
        {
            <ResumenProgreso 
                ProgresoGeneral="usuario.ProgresoGeneral" />
            
            <ResumenEvaluaciones
                IsLoading="isLoadingEvaluaciones"
                ErrorMessage="@errorMessageEvaluaciones"
                WarningMessage="@warningMessageEvaluaciones"
                Evaluaciones="evaluacionesResumen"
                Metricas="metricasEvaluaciones" />
            
            <ResumenTareas 
                TareasPendientes="tareasPendientes" TareasAsignadas="tareasAsignadas"
                TareasPersonales="tareasPersonales" IsLoading="isLoadingTareas"
                ErrorMessage="@errorMessageTareas" MaxAsignadas="5" />
            
                <ResumenInteres />
        }
    }
</div>

@code {
    // Estado de datos
    private List<TareaPersonalDto> tareasPersonales = new();
    private List<TareaAlumnoListadoDto> tareasAsignadas = new();
    private TareasPendientesResumenDto? tareasPendientes;
    private ApplicationUserDto usuario = new();
    private List<EvaluacionResumenItem> evaluacionesResumen = new();
    private ResumenEvaluacionesMetricasResultado metricasEvaluaciones =
        ResumenEvaluacionesMetricas.Calcular(Array.Empty<NotaVigenteEvaluacionResumen>());

    // Estado de carga
    private bool isLoadingUsuario = true;
    private bool isLoadingTareas = true;
    private bool isLoadingTip = true;
    private bool isLoadingEvaluaciones = true;

    // Errores
    private string? errorMessageUsuario;
    private string? errorMessageTareas;
    private string? errorMessageTip;
    private string? errorMessageEvaluaciones;
    private string? warningMessageEvaluaciones;
    private bool isAuthError;

    // Tip (bombilla)
    private string tip = "Aquí va tu consejo de programación...";
    private bool mostrarTip = false;
    private bool haVistoTip = false;

    // Usuario actual
    private string? userId;

    private readonly CancellationTokenSource cts = new();
    private static readonly JsonSerializerOptions JsonOptions = new(JsonSerializerDefaults.Web)
    {
        Converters = { new JsonStringEnumConverter() }
    };

    private string ErrorTitle => isAuthError ? "Necesitas iniciar sesión" : "No pudimos cargar tu resumen";
    private string ErrorMessage => isAuthError
    ? "Necesitas iniciar sesión para ver tu resumen."
    : errorMessageUsuario ?? "No se pudo cargar la información del usuario.";
    private int ErrorStatusCode => isAuthError ? 401 : 500;
    private string ErrorReturnUrl => isAuthError
    ? $"/Account/Login?returnUrl={Uri.EscapeDataString(navegador.Uri)}"
    : "/Resumen";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            Console.WriteLine($"Usuario autenticado: ID = {userId}");
            await CargarDatosAsync();
            await CargarTipDesdeAPI();
        }
        else
        {
            MostrarErrorAuth();
        }
    }

    private async Task CargarDatosAsync()
    {
        if (string.IsNullOrEmpty(userId))
        {
            MostrarErrorAuth();
            return;
        }

        var tareasTask = CargarTareasAsync(cts.Token);
        var usuarioTask = CargarUsuarioAsync(cts.Token);
        var evaluacionesTask = CargarEvaluacionesAsync(cts.Token);

        await Task.WhenAll(tareasTask, usuarioTask, evaluacionesTask);
    }

    private async Task CargarTareasAsync(CancellationToken token)
    {
        try
        {
            var tareasPersonalesResponse = await GetServiceResultAsync<List<TareaPersonalDto>>(
            $"{ServiceRoots.ACC_API_Url}Tarea/personal/lista/{userId}", token, allowNotFoundAsEmpty: true);
            var resumenPendientesResponse = await GetServiceResultAsync<TareasPendientesResumenDto>(
            $"{ServiceRoots.ACC_API_Url}TareasAlumno/resumen/{userId}", token);
            var tareasAsignadasResponse = await GetServiceResultAsync<List<TareaAlumnoListadoDto>>(
            $"{ServiceRoots.ACC_API_Url}TareasAlumno/listado/{userId}", token, allowNotFoundAsEmpty: true);

            if (tareasPersonalesResponse?.Success == true)
                tareasPersonales = tareasPersonalesResponse.Data ?? new();

            if (resumenPendientesResponse?.Success == true)
                tareasPendientes = resumenPendientesResponse.Data;

            if (tareasAsignadasResponse?.Success == true)
                tareasAsignadas = tareasAsignadasResponse.Data ?? new();

            if (tareasPersonalesResponse is null || resumenPendientesResponse is null || tareasAsignadasResponse is null ||
            tareasPersonalesResponse.Success != true || resumenPendientesResponse.Success != true || tareasAsignadasResponse.Success != true)
                errorMessageTareas = resumenPendientesResponse?.Message
                    ?? tareasAsignadasResponse?.Message
                    ?? tareasPersonalesResponse?.Message
                    ?? "Error al cargar las tareas.";

        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            MostrarErrorAuth();
        }
        catch (Exception ex)
        {
            errorMessageTareas = $"Error al cargar tareas: {ex.Message}";
        }
        finally
        {
            isLoadingTareas = false;
        }
    }

    private async Task CargarEvaluacionesAsync(CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(userId))
        {
            errorMessageEvaluaciones = "No se pudo cargar evaluaciones: usuario inválido.";
            isLoadingEvaluaciones = false;
            return;
        }

        try
        {
            errorMessageEvaluaciones = null;
            warningMessageEvaluaciones = null;
            token.ThrowIfCancellationRequested();

            var examenesSubTask = TryLoadConToleranciaAsync(
                () => ExamenesService.ObtenerExamanesSubMAsync(),
                new List<ExamenSubModuloDto>(),
                "No se pudo obtener la lista de exámenes por submódulo.");
            var examenesModTask = TryLoadConToleranciaAsync(
                () => ExamenesService.ObtenerExamenesModAsync(),
                new List<ExamenModuloDto>(),
                "No se pudo obtener la lista de exámenes por módulo.");
            var intentosTask = TryLoadConToleranciaAsync(
                () => ExamenesService.ObtenerIntentosPorUsuarioAsync(userId),
                new List<ExamenIntentoDto>(),
                "No se pudo obtener el historial de intentos.");

            await Task.WhenAll(examenesSubTask, examenesModTask, intentosTask);
            token.ThrowIfCancellationRequested();

            var examenesSub = examenesSubTask.Result;
            var examenesMod = examenesModTask.Result;
            var intentos = intentosTask.Result;

            var clavesCatalogo = ResumenEvaluacionesModelo.ObtenerClavesCatalogo(examenesSub, examenesMod);
            var habilitaciones = await ObtenerHabilitacionesPorEvaluacionAsync(userId, clavesCatalogo, token);

            evaluacionesResumen = ResumenEvaluacionesModelo
                .Construir(examenesSub, examenesMod, intentos, habilitaciones)
                .ToList();

            metricasEvaluaciones = CalcularMetricasDesdeItems(evaluacionesResumen);
        }
        catch (OperationCanceledException)
        {
            // Cancelación normal al salir de la vista.
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            MostrarErrorAuth();
        }
        catch (Exception ex)
        {
            errorMessageEvaluaciones = $"Error al cargar evaluaciones: {ex.Message}";
            evaluacionesResumen = [];
            metricasEvaluaciones = ResumenEvaluacionesMetricas.Calcular(Array.Empty<NotaVigenteEvaluacionResumen>());
        }
        finally
        {
            isLoadingEvaluaciones = false;
        }

        async Task<T> TryLoadConToleranciaAsync<T>(Func<Task<T>> carga, T fallback, string warning)
        {
            token.ThrowIfCancellationRequested();
            try
            {
                var result = await carga();
                return result is null ? fallback : result;
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                throw;
            }
            catch
            {
                AgregarWarningEvaluaciones(warning);
                return fallback;
            }
        }
    }

    private async Task<Dictionary<EvaluacionResumenKey, bool>> ObtenerHabilitacionesPorEvaluacionAsync(
        string usuarioId,
        IReadOnlyList<EvaluacionResumenKey> clavesCatalogo,
        CancellationToken token)
    {
        if (clavesCatalogo.Count == 0)
            return new Dictionary<EvaluacionResumenKey, bool>();

        var tareas = clavesCatalogo.Select(async clave =>
        {
            token.ThrowIfCancellationRequested();
            try
            {
                var habilitado = await ProgresoService.ExamenHabilitadoAsync(usuarioId, clave.Tipo, clave.RefId);
                return (Clave: clave, Habilitado: habilitado, Fallo: false);
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                throw;
            }
            catch
            {
                // Para evitar falsos "bloqueados" cuando falla la verificación.
                return (Clave: clave, Habilitado: true, Fallo: true);
            }
        });

        var resultados = await Task.WhenAll(tareas);
        if (resultados.Any(r => r.Fallo))
        {
            AgregarWarningEvaluaciones("No se pudo verificar el desbloqueo de algunas evaluaciones. Se mostraron con estado estimado.");
        }

        return resultados.ToDictionary(x => x.Clave, x => x.Habilitado);
    }

    private static ResumenEvaluacionesMetricasResultado CalcularMetricasDesdeItems(
        IEnumerable<EvaluacionResumenItem> items)
    {
        var notas = items
            .Where(i => i.UltimaCalificacion.HasValue && i.FechaUltimoIntento.HasValue)
            .Select(i => new NotaVigenteEvaluacionResumen(
                Tipo: i.Key.Tipo,
                ExamenId: i.ExamenId,
                NumeroIntento: i.IntentosUsados,
                Calificacion: i.UltimaCalificacion!.Value,
                FechaIntento: i.FechaUltimoIntento!.Value))
            .ToList();

        return ResumenEvaluacionesMetricas.Calcular(notas);
    }

    private void AgregarWarningEvaluaciones(string warning)
    {
        if (string.IsNullOrWhiteSpace(warning))
            return;

        if (string.IsNullOrWhiteSpace(warningMessageEvaluaciones))
        {
            warningMessageEvaluaciones = warning;
            return;
        }

        if (!warningMessageEvaluaciones.Contains(warning, StringComparison.Ordinal))
        {
            warningMessageEvaluaciones = $"{warningMessageEvaluaciones} {warning}";
        }
    }

    private async Task<ServiceResult<T>?> GetServiceResultAsync<T>(string url, CancellationToken token, bool allowNotFoundAsEmpty = false)
    {
        try
        {
            return await cliente.GetFromJsonAsync<ServiceResult<T>>(url, JsonOptions, token);
        }
        catch (HttpRequestException ex) when (allowNotFoundAsEmpty && ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            return ServiceResult<T>.Ok(default);
        }
    }

    private async Task CargarUsuarioAsync(CancellationToken token)
    {
        try
        {
            var solicitud = await
            cliente.GetFromJsonAsync<ServiceResult<ApplicationUserDto>>($"{ServiceRoots.ACC_API_Url}Usuario/usuario/{userId}",
            token);
            if (solicitud?.Success == true)
                usuario = solicitud.Data ?? new();
            else
                errorMessageUsuario = solicitud?.Message ?? "Error al cargar usuario.";
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            MostrarErrorAuth();
        }
        catch (Exception ex)
        {
            errorMessageUsuario = $"Error al cargar usuario: {ex.Message}";
        }
        finally
        {
            isLoadingUsuario = false;
        }
    }

    private async Task CargarTipDesdeAPI()
    {
        try
        {
            var tipObtenido = await cliente.GetFromJsonAsync<TipDto>($"{ServiceRoots.ACC_API_Url}Tips/random", cts.Token);
            if (tipObtenido is null)
            {
                errorMessageTip = "No hay tips disponibles aún.";
            }
            else
            {
                tip = tipObtenido.Contenido ?? "No hay tips disponibles aún.";
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            MostrarErrorAuth();
        }
        catch (Exception ex)
        {
            errorMessageTip = $"Error al obtener el Tip: {ex.Message}";
        }
        finally
        {
            isLoadingTip = false;
        }
    }

    private async Task ContinuarDondeLoDejaste()
    {
        if (string.IsNullOrWhiteSpace(userId))
        {
            return;
        }

        try
        {
            var ultimoTemaId = await cliente.GetFromJsonAsync<int?>($"{ServiceRoots.ACC_API_Url}ProgresoUsuario/ultimo/{userId}");

            if (ultimoTemaId.HasValue)
                navegador.NavigateTo($"contenido/Tema/{ultimoTemaId}");
            else
                Console.WriteLine("No se encontró progreso para el usuario.");
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            Console.WriteLine("No se encontró progreso para el usuario.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al obtener el progreso: {ex.Message}");
        }
    }

    private void MostrarTip()
    {
        mostrarTip = !mostrarTip;
        haVistoTip = true;
    }

    private void MostrarErrorAuth()
    {
        isAuthError = true;
        errorMessageUsuario = "Usuario no autenticado.";
        errorMessageTareas = "Usuario no autenticado.";
        errorMessageTip = "Usuario no autenticado.";
        errorMessageEvaluaciones = "Usuario no autenticado.";
        warningMessageEvaluaciones = null;
        isLoadingUsuario = false;
        isLoadingTareas = false;
        isLoadingTip = false;
        isLoadingEvaluaciones = false;
    }

    public void Dispose()
    {
        cts.Cancel();
        cts.Dispose();
    }
}
